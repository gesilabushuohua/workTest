<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>九联车辆识别系统</title>
    <script src="js/adapt.js"></script>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/carShow.css">
    <link rel="stylesheet" href="./js/vxgplayer/vxgplayer-1.8.40.min.css">
</head>
<body>
<div id="playShow">
    <div class="top" onclick="test()">
        九联车辆识别系统
    </div>
    <div class="middle">
        <div class="no-motor">
            <div id='left' class="no-motor-contain"></div>
        </div>
        <div class="play">
            <img src="image/n4/video.png"/>

            <div class="vlc-contain">
                <object type='application/x-vlc-plugin' id='vlc1' width="100%" height="100%"
                        style="position:absolute;display: none">
                    <param name='mrl' value=''/>
                    <param name="toolbar" value="false">
                    <param name='volume' value='0'/>
                    <param name='autoplay' value='true'/>
                    <param name='loop' value='false'/>
                    <param name='fullscreen' value='false'/>
                </object>
            </div>


            <div id="dynamicallyPlayers1" style="box-sizing: border-box;padding:0.3rem 0.2rem"></div>
        </div>
        <div class="play">
            <img src="image/n4/video.png"/>
            <div class="vlc-contain">
                <object type='application/x-vlc-plugin' id='vlc2'  width="100%" height="100%"
                        style="position:absolute;display: none">
                    <param name='mrl' value=''/>
                    <param name="toolbar" value="false">
                    <param name='volume' value='0'/>
                    <param name='autoplay' value='true'/>
                    <param name='loop' value='false'/>
                    <param name='fullscreen' value='false'/>
                </object>
            </div>
            <div id="dynamicallyPlayers2" style="box-sizing: border-box;padding:0.3rem 0.2rem"></div>
        </div>
        <div class="no-motor">
            <div id='right' class="no-motor-contain"></div>
        </div>
    </div>

    <div class="bottom">
        <div class="motor" id="motor">
            <!-- <div class="item">
                 <div class="bg">
                     <img src="image/n4/car.png">
                 </div>
                 <div class="info">
                     <div class="car-img">
                         <img src="http://192.168.135.63:8501/api/file/7,0792b943eb7738">
                     </div>
                     <div class="text">
                         <span>卡车 篮板 车尾</span>
                         <span>大型货车 蓝</span>
                         <span>粤RF163S</span>
                     </div>
                 </div>
             </div>
             <div class="item">
                 <div class="bg">
                     <img src="image/n4/car.png">
                 </div>
                 <div class="info">
                     <div class="car-img">
                         <img src="http://192.168.135.63:8501/api/file/7,0792b943eb7738">
                     </div>
                     <div class="text">
                         <span>卡车 篮板 车尾</span>
                         <span>大型货车 蓝</span>
                         <span>粤RF163S</span>
                     </div>
                 </div>
             </div>
             <div class="item">
                 <div class="bg">
                     <img src="image/n4/car.png">
                 </div>
                 <div class="info">
                     <div class="car-img">
                         <img src="http://192.168.135.63:8501/api/file/7,0792b943eb7738">
                     </div>
                     <div class="text">
                         <span>卡车 篮板 车尾</span>
                         <span>大型货车 蓝</span>
                         <span>粤RF163S</span>
                     </div>
                 </div>
             </div>
             <div class="item">
                 <div class="bg">
                     <img src="image/n4/car.png">
                 </div>
                 <div class="info">
                     <div class="car-img">
                         <img src="http://192.168.135.63:8501/api/file/7,0792b943eb7738">
                     </div>
                     <div class="text">
                         <span>卡车 篮板 车尾</span>
                         <span>大型货车 蓝</span>
                         <span>粤RF163S</span>
                     </div>
                 </div>
             </div>-->
        </div>

    </div>

</div>

</body>
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/websocket/stomp.min.js"></script>
<script src="js/websocket/sockjs.min.js"></script>
<script src="js/vxgplayer/vxgplayer-1.8.40.js"></script>
<script src="js/config.js"></script>
<script src="js/carBrand.js"></script>
<script src="js/transform.js"></script>
<script>
    var host = "http://192.168.135.63:9099";
    var initData = {
        'win1PlayUrl': '',
        'win2PlayUrl': '',
        'win1sensorId': '',
        'win2sensorId': ''
    };
    var w = 0, h = 0;
    window.onload = function () {
        postResultData('/show/getData');
        connect();

    }

    function test() {
        $('#left').removeClass('no-motor-contain');
        $('#left').addClass('animation-no-motor-contain');
    }

    function addMotor(result) {
        //机动车
        var dom = $('#motor');
        var div = ''
        div = insertCar(/*1,*/ result);
        dom.append(div);
        dom.addClass('animation-motor');
        var timer = setTimeout(function () {
            if (getBroswer().broswer === 'IE'){
                dom.children('div').get(0).removeNode(true);
            }else {
                dom.children('div').get(0).remove();
            }

            dom.removeClass('animation-motor');
            clearTimeout(timer);
        }, 0.15 * 1000);
    }

    function addNomotor(dom, imgUrl) {
        //判断前门物流门
        var div = insertNomotor(imgUrl);
        dom.append(div);
        dom.removeClass('no-motor-contain');
        dom.addClass('animation-no-motor-contain');
        var timer = setTimeout(function () {
            if (getBroswer().broswer === 'IE'){
                dom.children('div').get(0).removeNode(true);
            }else {
                dom.children('div').get(0).remove();
            }
            dom.removeClass('animation-no-motor-contain');
            dom.addClass('no-motor-contain');
            clearTimeout(timer);
        }, 0.15 * 1000);
    }

    function connect() {
        var socket = new SockJS(host + '/webpoint');
        var stompClient = Stomp.over(socket);
        console.info('wensocket 连接');
        var connectCallback = function () {

            stompClient.subscribe('/topic/getMessage', function (response) {
                //console.info(JSON.parse(response.body));
                formtParam(JSON.parse(response.body));

            });
        }
        var errorCallback = function () {
            connect();
            /*  if(!conTimer){
                console.info('开定时器');
                conTimer=setInterval(function () {
                  console.info('连接中---');
                  stompClient.connect({},connectCallback, errorCallback);
                }, 2*1000);
              }*/
        }

        stompClient.connect({}, connectCallback, errorCallback);
    }

    function postResultData(targetUrl) {
        $.ajax({
            type: 'Get',
            method: 'Get',
            url: host + targetUrl,
            dataType: "json",
            timeout: 5000,
            success: function (data) {
                if (data != null) {
                    // console.info(data);
                    initData.win1PlayUrl = "rtsp://admin:admin@192.168.135.63:10011"/*data.win1playUrl*/;
                    //initData.win1PlayUrl = "rtsp://admin:a12345678@192.168.135.63:10012";
                    initData.win2PlayUrl = "rtsp://admin:a12345678@192.168.135.63:10012" /*data.win2playUrl*/;
                    initData.win1sensorId = data.win1sensorId;//物流门
                    initData.win2sensorId = data.win2sensorId;//前门
                    var dom = $('#left');
                    initNoMotor(4, dom, data.motor);
                    dom = $('#right');
                    initNoMotor(8, dom, data.motor);
                    var html = document.getElementsByTagName('html')[0];
                    var pageWidth = html.getBoundingClientRect().width;
                    w = pageWidth * 0.07;
                    h = pageWidth * 0.01;
                    initMotor(data.win1data);
                    loadPlay();
                }
            }
        });
    }

    function initMotor(motor) {
        var i = 0;
        var div = '';
        var result = null;
        var brand = ''
        for (i = 0; i < 4; i++) {
            /*  div += ' <div class="item-contain">'*/

            result = {
                "imgUri": replaceURL(motor[i].RecVehicle.Img.Img.URI),
                "plate": motor[i].RecVehicle.Plates ? motor[i].RecVehicle.Plates[0].PlateText : '未知',
                "brand": getNameByBrandID(motor[i].RecVehicle.ModelType.BrandId,
                    motor[i].RecVehicle.ModelType.SubBrandId,
                    motor[i].RecVehicle.ModelType.ModelYearId),
                "type": getNameByStyleID(motor[i].RecVehicle.ModelType.StyleId) +
                " " + getCarColorByColorID(motor[i].RecVehicle.Color.ColorId),
                "site": 2,
                "department": null,
                "user": null
            };
            if (motor[i].Metadata.SensorId === initData.win1sensorId) {
                result.site = '物流门';
            } else {
                result.site = '前门';
            }
            div += insertCar(result);
            /*
             result = {
                 "imgUri": replaceURL(motor[i + 1].RecVehicle.Img.Img.URI),
                 "plate": motor[i + 1].RecVehicle.Plates ? motor[i + 1].RecVehicle.Plates[0].PlateText : '未知',
                 "brand": getNameByBrandID(motor[i + 1].RecVehicle.ModelType.BrandId,
                     motor[i + 1].RecVehicle.ModelType.SubBrandId,
                     motor[i + 1].RecVehicle.ModelType.ModelYearId),
                 "type": getNameByStyleID(motor[i + 1].RecVehicle.ModelType.StyleId) + " " +
                 getCarColorByColorID(motor[i + 1].RecVehicle.Color.ColorId),
                 "isBelong": 2,
                 "department": null,
                 "user": null,
             };
             div += insertCar(2, result);*/
            /*  div += ' </div>'*/

        }
        $('#motor').append(div);
    }

    function initNoMotor(end, dom, noMotor) {
        var i = 0;
        var div = '';
        if (end === 4) {
            i = 0;
        } else {
            i = 4;
        }
        for (i; i < end; i++) {
            div += insertNomotor(replaceURL(noMotor[i].RecNonMotorVehicle.Img.Img.URI));
        }
        dom.append(div);

    }

    function formtParam(data) {

        //判断人车 1车 2 3 机动车 行人
        if (data.showType === 1) {
            console.info(data);
            var result = {
                "imgUri": replaceURL(data.vo.imgUrl),
                "plate": data.vo.plateText ? data.vo.plateText : '未知',
                "brand": data.vo.brand + ' ' + data.vo.subBrand + ' ' + data.vo.modelYear,
                "type": data.vo.style + ' ' + data.vo.colourName,
                "site": '',
                "department": data.vo.department ? '' : data.vo.department,
                "user": data.vo.master ? '' : data.vo.master
            };
            if (data.vo.sensorId === initData.win1sensorId) {
                result.site = '物流门';
            } else {
                result.site = '前门';
            }
            addMotor(result);
        } else {
            var dom = null;
            if (data.vo.sensorId === initData.win2sensorId) {
                dom = $('#left');
            } else {
                dom = $('#right')
            }
            addNomotor(dom, replaceURL(data.vo.imgUrl))
        }

    }

    function insertCar(/*type,*/ result) {
        var div = ''
        /* if (type === 1) {//增加一列
             div += ' <div class="item-contain">'
         }*/
        div += '<div class="item">\n' +
            '                <div class="bg">\n' +
            '                    <img src="image/n4/car.png"/>\n' +
            '                </div>\n' +
            '                <div class="info">\n' +
            '                    <div class="car-img">\n' +
            '                        <img src="' + result.imgUri + '"/>\n' +
            '                    </div>\n' +
            '                    <div class="text">\n';

        if (parseInt(result.brand.length) > parseInt(16)) {
            //  console.info(w,h);
            /* div += ' <marquee direction="left" behavior="scroll" scrollamount="2"\n' +
                 '                             height="' + h + 'px"    width="' + w + 'px" scrolldelay="0" loop="-1">\n' +
                 '                      ' + result.brand + '\n' +
                 '                    </marquee>'*/
            div += '<span class="text-slide">' + result.brand + '</span>';
        } else {
            div += isValid(result.brand);
        }
        div += isValid(result.type);
        div += isValid(result.plate);
        div += isValid(result.site);
        div += isValid(result.department);
        div += isValid(result.user);
        div += '                    </div>\n' +
            '                </div>\n' +
            '            </div>';

        /* if (type === 1) {//增加一列
             div += '  </div>'
         }*/
        return div;
    }

    function isValid(str) {
        if (str && str !== 'null' && str !== undefined && str !== '未知') {
            //console.info(str);
            return '<span>' + str + '</span>\n';
        }
        return '';

    }

    function insertNomotor(imgUrl) {
        var div = ' <div class="item">\n' +
            '                <div class="bg">\n' +
            '                    <img src="image/n4/picture.png"/>\n' +
            '                </div>\n' +
            '                <img class="p-img" src="' + imgUrl + '"/>\n' +
            '            </div>';

        return div;
    }


    function loadPlay() {
        var html = document.getElementsByTagName('html')[0];
        w = html.getBoundingClientRect().width;
        h = html.getBoundingClientRect().height;
        console.info("page: " + w);
        console.info("page: " + h);
        //console.info('12345',initData.win1PlayUrl,initData.win2PlayUrl);
        if (typeof(androidPlayer) !== 'undefined') {
            console.info('androidPlayer');
            androidPlayer.start(0, w * 0.138, h * 0.22, w * 0.58, h * 0.82, initData.win1PlayUrl);
            androidPlayer.start(1, w * 0.775, h * 0.22, w * 0.58, h * 0.82, initData.win2PlayUrl);
        } else if (getBroswer().broswer === 'Chrome') {//谷歌

            document.getElementById('dynamicallyPlayers1').style.display = 'block';
            document.getElementById('dynamicallyPlayers2').style.display = 'block';
            createVxgPlayer('dynamicallyPlayers1', initData.win2PlayUrl);
            createVxgPlayer('dynamicallyPlayers2', initData.win1PlayUrl);
        } else if (getBroswer().broswer === 'IE') {//IE
            document.getElementById('vlc1').style.display = 'block';
            document.getElementById('vlc2').style.display = 'block';
            createVlcPlayer('vlc1', initData.win1PlayUrl);
            createVlcPlayer('vlc2', initData.win2PlayUrl);
        }
    }

    function createVlcPlayer(vlcId, url) {
        var options = new Array("rtsp-tcp");
        $('#vlc1').css("left", 0.02 * w + 'px');
        $('#vlc1').css("top", 0.03 * w + 'px');
        console.info('hahha');
        var vlc = document.getElementById(vlcId);
        var idd = vlc.playlist.add(url, "fancy name", options);
        vlc.playlist.playItem(idd);
    }

    function createVxgPlayer(dynamicallyPlayers, url) {
        var playerId = dynamicallyPlayers;
        var div = document.createElement('div');
        div.setAttribute("id", playerId);
        div.setAttribute("class", "vxgplayer");
        var runtimePlayers = document.getElementById(dynamicallyPlayers);
        runtimePlayers.appendChild(div);
        console.info(w * 0.7, h * 0.8);
        vxgplayer(playerId).size(w * 0.65, h * 0.8);
        vxgplayer(playerId, {
            url: '',
            nmf_path: 'media_player.nmf',
            nmf_src: 'pnacl/Release/media_player.nmf',
            latency: 300000,
            aspect_ratio_mode: 1,
            autohide: 3,
            controls: false,
            connection_timeout: 5000,
            connection_udp: 0,
            custom_digital_zoom: false
        }).ready(function () {
            console.log(' =>ready player ' + playerId);
            vxgplayer(playerId).src(url);
            vxgplayer(playerId).play();
            vxgplayer(playerId).onBandwidthError(function (player) {
                console.log(player.error());
            });
            console.log(' <=ready player ' + playerId);
        });
    }

    function getBroswer() {
        var sys = {};
        var ua = navigator.userAgent.toLowerCase();
        var s;
        (s = ua.match(/edge\/([\d.]+)/)) ? sys.edge = s[1] :
            (s = ua.match(/rv:([\d.]+)\) like gecko/)) ? sys.ie = s[1] :
                (s = ua.match(/msie ([\d.]+)/)) ? sys.ie = s[1] :
                    (s = ua.match(/firefox\/([\d.]+)/)) ? sys.firefox = s[1] :
                        (s = ua.match(/chrome\/([\d.]+)/)) ? sys.chrome = s[1] :
                            (s = ua.match(/opera.([\d.]+)/)) ? sys.opera = s[1] :
                                (s = ua.match(/version\/([\d.]+).*safari/)) ? sys.safari = s[1] : 0;

        if (sys.edge) return {broswer: "Edge", version: sys.edge};
        if (sys.ie) return {broswer: "IE", version: sys.ie};
        if (sys.firefox) return {broswer: "Firefox", version: sys.firefox};
        if (sys.chrome) return {broswer: "Chrome", version: sys.chrome};
        if (sys.opera) return {broswer: "Opera", version: sys.opera};
        if (sys.safari) return {broswer: "Safari", version: sys.safari};
        return {broswer: "", version: "0"};
    }
</script>
</html>