<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>九联人脸识别系统</title>
    <script src="js/adapt.js"></script>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/faceShow.css">
</head>
<body>
<div id="playShow">
    <div class="top">
        九联人脸识别系统
    </div>
    <div class="middle">
        <div class="play">
            <img src="image/n4/video.png"/>

        </div>
        <div class="person">
            <div class="contain" id="bg">
                <img class="bg" src="image/n4/border.png">
                <div class="load-info">
                    <div class="text">九联欢迎您</div>
                    <div class="load">
                        <img src="image/39.gif">
                    </div>
                </div>
            </div>

            <div class="contain" id="right-contain">
            </div>


        </div>
    </div>
    <div class="bottom">
        <div class="contain" id="bottom-contain">
        </div>

    </div>
</div>
</body>
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/websocket/stomp.min.js"></script>
<script src="js/websocket/sockjs.min.js"></script>
<script src="js/Decoder.js"></script>
<script src="js/twgl.js"></script>
<script src="js/faceplayer.js"></script>
<script>

    //var faceHost="http://192.168.135.63:8088";
    var faceHost="http://192.168.135.63:8088";
    var hostname= "192.168.130.109:8061";
    var videoWs=null,_ws=null;
    var query= {
        url: "rtsp://admin:admin1234@192.168.130.101",
        analyze: "true",
        crop: ["face"],
        facemin: "48",
        group: "",
        hitrate: "0.5",
        hitrate_score: "72",
        interval: "5000",
        keepclip: "",
        limit: "5",
        name: "live1",
        quality: "",
        record: "",
        roi: "",
        scoregap: "",
        tracer: ""
    };

    window.onload = function () {
        var html = document.getElementsByTagName('html')[0];
        var pageWidth = html.getBoundingClientRect().width;
        var w = pageWidth * 0.546;
        var h = pageWidth * 0.34;
        $('.play').append('<canvas class="canvas" width="'+w+'" height="'+h+'"\n' +
            'style="box-shadow: 0 0 20px #080F3F;"></canvas>');
        getInintData();
    }


    function getInintData(){
        $.ajax({
            type: 'Get',
            method: 'Get',
            url: faceHost + "/getAvail",
            timeout: 5000,
            success: function (data) {
                if (data != null) {
                    console.info(data);
                    if(data.code===1){
                        query.url=data.data.uri;
                        pictureWs();
                        connect();
                        // query.name=data.data.name;
                        /*  setTimeout(function () {
                              streamWs();
                          }, 1000);*/
                    }
                }
            }
        });
    }

    function reset() {
        var html = document.getElementsByTagName('html')[0];
        var pageWidth = html.getBoundingClientRect().width;
        var w = pageWidth * 0.546;
        var h = pageWidth * 0.34;
        $('.play').append('<canvas class="canvas" width="'+w+'" height="'+h+'"\n' +
            'style="box-shadow: 0 0 20px #080F3F;"></canvas>');

        pictureWs();
        /* setTimeout(function () {
             streamWs();
         }, 1000);*/
        connect();
    }

    var name='um';
    function connect() {
        var socket = new SockJS(faceHost + '/endpointWarning');
        var stompClient = Stomp.over(socket);
        var connectCallback = function () {
            console.info('face websocket 开启');
            stompClient.subscribe('/topic/getMessage', function (response) {
                console.info(JSON.parse(response.body));
                var data=JSON.parse(response.body);
                if(data.message==='切换摄像头'){
                    // query.name=data.data.name;
                    query.url=data.data.uri;
                    $('.play').children('canvas').remove();
                    stompClient.disconnect();
                    videoWs.onclose();
                    _ws.onclose();
                    reset();
                }else if(data.message==='布控人员'){
                    var score=0,index=0;
                    for (var i = 0; i < data.data.alertResultViewDtoList.length; i++) {
                        if (score < data.data.alertResultViewDtoList[i].score) {
                            score = data.data.alertResultViewDtoList[i].score;
                            index = i;
                        }
                    }
                    if(name!== data.data.alertResultViewDtoList[index].name && score > 70){
                        name=data.data.alertResultViewDtoList[index].name;
                        var result = {
                            'department': data.data.alertResultViewDtoList[index].workPlaceCent,
                            'name': data.data.alertResultViewDtoList[index].name,
                            'sex': 1,
                            'charmScore': data.data.alertResultViewDtoList[index].magicScore,
                            'age': data.data.age,
                            'happyScore': data.data.alertResultViewDtoList[index].happyScore,
                            'lifeImg': '',
                            'secImg': "data:image/png;base64," + data.data.base64Img,
                            'workImg':''
                        };
                        if(imgValid(data.data.alertResultViewDtoList[index].workPicUri)){
                            result.workImg=data.data.alertResultViewDtoList[index].workPicUri;

                        }else {
                            result.workImg="data:image/png;base64," + data.data.base64Img;
                        }

                        if(imgValid(data.data.alertResultViewDtoList[index].lifeImgUri)){
                            result.lifeImg=data.data.alertResultViewDtoList[index].lifeImgUri;
                        }else  if(imgValid(data.data.alertResultViewDtoList[index].workPicUri)){
                            result.lifeImg=data.data.alertResultViewDtoList[index].workPicUri;
                        }else {
                            result.lifeImg="data:image/png;base64," + data.data.base64Img;
                        }

                        if (data.data.gender.male < data.data.gender.female){
                            result.sex=2;
                        }else {
                            result.sex=1;
                        }

                        addRight(result);
                    }else {

                    }

                }


            });
        }
        var errorCallback = function () {
            console.info('websocket 关闭');
            connect();
        }

        stompClient.connect({}, connectCallback, errorCallback);
    }

    function imgValid(url) {
        if (url && url !== 'null' && url !== undefined && url !== '') {
            //console.info(str);
            return true;
        }
        return false;
    }

    function urlEncode(kv) {
        var comps = [];
        for (var key in kv) {
            comps.push(encodeURIComponent(key) + '=' + encodeURIComponent(kv[key]));
        }
        return comps.join('&');
    }


    function pictureWs() {
        var api = "/video";
        videoWs = new WebSocket('ws://' + hostname + api + '?' + urlEncode(query));
        videoWs.onmessage = function (e) {
            //console.info(JSON.parse(e.data));
            /*var data = JSON.parse(e.data);
            if (data.type === 'recognize' || data.type === 'alter') {
              if (data.track >= track) {
                track = data.track;
                var face = {
                  "img": "data:image/png;base64," + data.face.crop.image,
                  "classType": ""
                };
                if (data.face.attrs.gender.male < data.face.attrs.gender.female) {
                  face.classType = 'g-person'
                } else {
                  face.classType = 'b-person'
                }
                addNoMotor(face);
              }

            }*/

        };

        videoWs.onopen = function (e) {
            console.info("websocket 开启");
            setTimeout(function () {
                streamWs();
            }, 1000);
        };

        videoWs.onclose = function (e) {
            console.info("websocket 结束");
        };
    }

    function streamWs() {

        _ws = new WebSocket('ws://' + hostname + '/video_stream?name=' + query.name);
        console.info('ws://' + hostname + '/video_stream?name=' + query.name);
        _ws.binaryType = "arraybuffer";
        var canvas = document.querySelector('canvas');
        var player = new FacePlayer(canvas);
        var frameheader;
        _ws.onmessage = function (e) {
            var data = e.data;
            if (typeof data === 'string') {//人脸信息
                var result = JSON.parse(data);
                console.info(result);
                var rects = result.faces.map(function (d) {
                    return {
                        left: d.rect.left / 960 * 10000,
                        top: d.rect.top / 540 * 10000,
                        right: (d.rect.left + d.rect.width) / 960 * 10000,
                        bottom: (d.rect.top + d.rect.height) / 540 * 10000,
                    };
                });
                frameheader = {
                    type: result.type,
                    pts: result.pts,
                    key: result.key,
                    rects: rects,
                };
            } else {// ws推送的字节流+人脸信息（渲染信息）
                //rtsp data frame & faceInfo
                player.decodeDraw(new Uint8Array(data), frameheader);
            }
        };
        _ws.onclose = function (e) {
            if (this.onclose) {
                console.info("streamWs 结束");
                this.onclose(e);
            }
        }.bind(this);

        _ws.onopen = function (e) {
            if (this.onopen) {
                console.info("streamWs 开始");
                this.onopen(e);

            }
        }.bind(this);
    }


    function addBottom(result){

        var div=insertBottom(result);
        var dom=$('#bottom-contain');
        dom.append(div);
        if(dom.children('div').length>4){
            dom.addClass('animation');
            var timer = setTimeout(function () {
                dom.children('div').get(0).remove();
                dom.removeClass('animation');
                clearTimeout(timer);
            }, 0.15 * 1000);
        }

    }

    function addRight(result) {
        var div = insertRight(result);
        var dom = $('#right-contain');
        var bg = $('#bg')[0]
        bg.style.display = 'none';
        dom.append(div);

        if(dom.children('div').length>3){
            dom.addClass('animation-top');
            var timer = setTimeout(function () {
                if(dom.children('div').length>0){
                    dom.children('div').get(0).remove();
                    dom.removeClass('animation-top');
                }
                clearTimeout(timer);
            }, 0.15 * 1000);
        }
        dom.children('div:last-child').delay(15*1000);
        dom.children('div:last-child').animate({
            height:0,
            opacity:0
        },0.15*1000,function () {
            console.info($(this));
            addBottom(result);
            $(this).remove();
            if(dom.children('div').length===0){
                bg.style.display = '';
            }
        });


    }

    function insertRight(result) {
        var div = '';
        var sex1 = '', sex2 = '';
        if (result.sex===1) {
            sex1 = '男';
            sex2 = 'Male';
        } else {
            sex1 = '女';
            sex2 = 'Female';
        }
        div += '  <div class="person-info">\n' +
            '                <img class="bg-img" src="image/n4/info.png"/>\n' +
            '                <div class="info">\n' +
            '                    <div class="rect">\n' +
            '                        <img src="'+result.secImg+'"/>\n' +
            '                    </div>\n' +
            '                    <span class="department">\n' + result.department +
            '              <i class="remark">Department</i>\n' +
            '            </span>\n' +
            '                    <span class="name">' + result.name +
            '                <i class="remark">Name</i>\n' +
            '            </span>\n' +
            '                    <span class="sex">' + sex1 + ' <i class="large-remark">' + sex2 + '</i></span>\n' +
            '                    <span class="charmScore">\n' +
            '              <i class="score">' + result.charmScore + '</i>\n' +
            '              魅力值\n' +
            '               <i class="remark">Charming</i>\n' +
            '            </span>\n' +
            '                    <span class="age">\n' +
            '              <i class="score">' + result.age + '</i>\n' +
            '               <i class="remark">Age</i>\n' +
            '            </span>\n' +
            '                    <span class="happyScore"><i class="score">' + result.happyScore + '</i> 欢乐指\n' +
            '              <i class="remark">Happy</i>\n' +
            '            </span>\n' +
            '                </div>\n' +
            '            </div>';
        return div;
    }

    var sum = 0;

    function insertBottom(result) {
        var div = '';
        div += '<div class="person">\n' +
            '                <div class="bg">\n' +
            '                    <img class="bg-img" src="image/n4/car.png"/>\n' +
            '                    <img class="big-img" src="' + result.lifeImg + '"/>\n' +
            '                </div>\n' +
            '                <div class="img-contain">\n' +
            '                    <img class="p-img" src="' + result.secImg + '"/>\n' +
            '                    <img class="p-img" src="' + result.workImg + '"/>\n' +
            '                </div>\n' +
            '                <div class="info">' + result.department+'-'+result.name +
            '                </div>\n' +
            '            </div>';
        return div;
    }
</script>
</html>